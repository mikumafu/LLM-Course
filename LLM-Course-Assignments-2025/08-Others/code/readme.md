# å¤šæ¨¡æ€è„‘ç”µä¿¡å·å›¾åƒç”Ÿæˆç³»ç»Ÿ

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŸºäºè„‘ç”µä¿¡å·ï¼ˆEEGï¼‰çš„å¤šæ¨¡æ€å›¾åƒç”Ÿæˆç³»ç»Ÿï¼Œèƒ½å¤Ÿä»EEGä¿¡å·ä¸­æå–ç‰¹å¾å¹¶é‡å»ºç›¸åº”çš„è§†è§‰åˆºæ¿€ã€‚ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ³¨å…¥ç­–ç•¥å’Œæ¸è¿›å¼æ¨¡æ€èåˆï¼Œå®ç°äº†å¯¹EEGä¿¡å·çš„æ·±åº¦ç†è§£å’Œé«˜è´¨é‡çš„å›¾åƒé‡å»ºã€‚

## ğŸ¯ æ¨¡å‹æ¶æ„

![](.\picture\model.png)

> **æ¨¡å‹æ¶æ„è¯´æ˜**ï¼šç³»ç»ŸåŒ…å«ä¸‰ä¸ªæ ¸å¿ƒæ¨¡å—ï¼šEEGç‰¹å¾æå–å™¨ã€å¤šæ¨¡æ€æ‰©æ•£å…ˆéªŒæ¨¡å‹å’Œåˆ†å±‚æ³¨å…¥å›¾åƒç”Ÿæˆå™¨ã€‚EEGä¿¡å·é¦–å…ˆé€šè¿‡ä¸“é—¨è®¾è®¡çš„ç¼–ç å™¨æå–ç‰¹å¾ï¼Œç„¶ååˆ†åˆ«é€å…¥5ä¸ªç‹¬ç«‹çš„æ‰©æ•£å…ˆéªŒæ¨¡å‹ï¼ˆå¯¹åº”å›¾åƒã€æ–‡æœ¬å’Œä¸‰ä¸ªå°ºåº¦çš„è¶…åƒç´ ç‰¹å¾ï¼‰ï¼Œç”Ÿæˆå¯¹åº”çš„CLIPåµŒå…¥ã€‚è¿™äº›åµŒå…¥é€šè¿‡IP-Adapteråˆ†å±‚æ³¨å…¥åˆ°Stable Diffusion XLä¸­ï¼Œåœ¨ä¸åŒç½‘ç»œæ·±åº¦èåˆä¸åŒæ¨¡æ€çš„ç‰¹å¾ã€‚

## âœ¨ æ•ˆæœå±•ç¤º

![origin](.\picture\origin.jpeg)![few](.\picture\few.jpeg)![middle](.\picture\middle.jpeg)![large](.\picture\large.jpeg)![generate](.\picture\generate.png)

> **å›¾åƒè¯´æ˜**ï¼šä»å·¦ä¸Šä¾æ¬¡æ˜¯åŸå§‹å›¾åƒï¼Œfewçº§åˆ«è¶…åƒç´ å›¾ï¼Œmiddleçº§åˆ«è¶…åƒç´ å›¾ï¼Œlargeçº§åˆ«è¶…åƒç´ å›¾ï¼Œæœ€ç»ˆç”Ÿæˆå›¾åƒã€‚

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### ç¯å¢ƒé…ç½®

bash

```
# åˆ›å»ºå¹¶æ¿€æ´»condaç¯å¢ƒ
conda create -n eeg2img python=3.9
conda activate eeg2img

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å®‰è£…PyTorchï¼ˆæ ¹æ®CUDAç‰ˆæœ¬é€‰æ‹©ï¼‰
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```



### æ•°æ®é›†ä¸‹è½½

1. **Things-EEG2 æ•°æ®é›†**
   - å›¾åƒæ•°æ®ï¼šhttps://osf.io/jum2f/files/osfstorage
   - è„‘ç”µä¿¡å·æ•°æ®ï¼šhttps://osf.io/anp5v/files/osfstorage
2. **é¢„è®­ç»ƒæ¨¡å‹æƒé‡**
   - Stable Diffusion XLï¼š`sd_xl_base_1.0.safetensors`ï¼ˆ[HuggingFace](https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0)ï¼‰
   - IP-Adapteræƒé‡ï¼š`ip-adapter_sdxl_vit-h.safetensors`ï¼ˆ[HuggingFace](https://huggingface.co/h94/IP-Adapter)ï¼‰
3. **EEGç¼–ç å™¨å‚è€ƒå®ç°**
   - æœ¬é¡¹ç›®ä½¿ç”¨çš„EEGç¼–ç å™¨åŸºäºä»¥ä¸‹å·¥ä½œå®ç°ï¼š[EEG_Image_decode](https://github.com/ncclab-sustech/EEG_Image_decode)

### è·¯å¾„é…ç½®

æ ¹æ®ä½ çš„å®é™…æ–‡ä»¶è·¯å¾„ä¿®æ”¹ä»¥ä¸‹é…ç½®æ–‡ä»¶ï¼š

1. **ä¸»è¦é…ç½®æ–‡ä»¶ä½ç½®**ï¼š

   - `arg.py`ï¼šä¸»è¦è®­ç»ƒå’Œç”Ÿæˆå‚æ•°
   - `train.py`ï¼šè®­ç»ƒè„šæœ¬ä¸­çš„è·¯å¾„è®¾ç½®
   - `generate.py`ï¼šç”Ÿæˆè„šæœ¬ä¸­çš„è·¯å¾„è®¾ç½®

2. **éœ€è¦ä¿®æ”¹çš„å…³é”®è·¯å¾„**ï¼š

   python

   ```
   # æ•°æ®è·¯å¾„
   data_path = "ä½ çš„/æ•°æ®/è·¯å¾„/Preprocessed_data_250Hz"
   superpixel_base_path = "ä½ çš„/è¶…åƒç´ /è·¯å¾„/processed_images"
   
   # æ¨¡å‹è·¯å¾„
   sd_model_path = "ä½ çš„/æ¨¡å‹/è·¯å¾„/sd_xl_base_1.0.safetensors"
   ip_adapter_weight_path = "ä½ çš„/é€‚é…å™¨/è·¯å¾„/ip-adapter_sdxl_vit-h.safetensors"
   
   # è¾“å‡ºè·¯å¾„
   output_dir = "ä½ çš„/è¾“å‡º/è·¯å¾„/outputs"
   ```

   

### è¿è¡Œæµç¨‹

#### æ­¥éª¤1ï¼šæ•°æ®é¢„å¤„ç†

bash

```
# æå–CLIPç‰¹å¾
python clip_feature_extractor.py \
    --data_path ä½ çš„/æ•°æ®/è·¯å¾„ \
    --output_path ä½ çš„/è¾“å‡º/è·¯å¾„/clip_features \
    --batch_size 32
```



æ­¤æ­¥éª¤å°†åŸå§‹å›¾åƒå’Œæ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºCLIPåµŒå…¥ç‰¹å¾ï¼Œç”¨äºåç»­è®­ç»ƒã€‚

#### æ­¥éª¤2ï¼šæ¨¡å‹è®­ç»ƒ

bash

```
# è®­ç»ƒå¤šæ¨¡æ€æ‰©æ•£æ¨¡å‹
python train.py \
    --data_path ä½ çš„/æ•°æ®/è·¯å¾„ \
    --clip_feature_path ä½ çš„/ç‰¹å¾/è·¯å¾„ \
    --output_dir ä½ çš„/æ¨¡å‹/ä¿å­˜/è·¯å¾„ \
    --epochs 100 \
    --batch_size 16 \
    --learning_rate 1e-4
```



è®­ç»ƒè¿‡ç¨‹å°†åŒæ—¶ä¼˜åŒ–EEGç¼–ç å™¨å’Œ5ä¸ªæ‰©æ•£å…ˆéªŒæ¨¡å‹ã€‚

#### æ­¥éª¤3ï¼šå›¾åƒç”Ÿæˆ

bash

```
# ç”Ÿæˆå›¾åƒ
python generate.py \
    --eeg_data æµ‹è¯•/EEG/æ•°æ® \
    --model_path è®­ç»ƒå¥½çš„/æ¨¡å‹/è·¯å¾„ \
    --sd_model_path SDXL/æ¨¡å‹/è·¯å¾„ \
    --ip_adapter_path IP-Adapter/è·¯å¾„ \
    --output_dir ç”Ÿæˆ/å›¾åƒ/ä¿å­˜/è·¯å¾„ \
    --mode all  # å¯é€‰: separate, fused, progressive
```



## ğŸ“ é¡¹ç›®ç»“æ„

text

```
code/
â”œâ”€â”€ subject_layers/        # è¢«è¯•ç‰¹å®šå±‚
â”œâ”€â”€ ATMS_retrieval.py     # EEGæ—¶åºå»ºæ¨¡æ¨¡å—
â”œâ”€â”€ masking.py           # æ©ç ç­–ç•¥
â”‚
â”œâ”€â”€ clip_feature_extractor.py  # CLIPç‰¹å¾æå–å™¨
â”œâ”€â”€ dataset.py              # æ•°æ®åŠ è½½å™¨
â”œâ”€â”€ train.py               # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ generate.py           # ç”Ÿæˆè„šæœ¬
â”œâ”€â”€ unet.py                 # æ‰©æ•£å…ˆéªŒæ¨¡å‹
â”œâ”€â”€ args.py                 # å‚æ•°é…ç½®
â”œâ”€â”€ util.py                  # è¾…åŠ©å·¥å…·
â”œâ”€â”€ loss.py                 # æŸå¤±å‡½æ•°æ¨¡å—
â”‚
â”œâ”€â”€ requirements.txt      # ä¾èµ–åŒ…åˆ—è¡¨
â””â”€â”€ README.md           # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```



### éƒ¨åˆ†æ¨¡å—è¯¦ç»†è¯´æ˜

#### 1. EEGç¼–ç å™¨ç›¸å…³

- **subject_layers/**: åŒ…å«é’ˆå¯¹ä¸åŒè¢«è¯•çš„ä¸ªæ€§åŒ–é€‚é…å±‚
- **ATMS_retrieval.py**: å®ç°åŸºäºæ³¨æ„åŠ›çš„EEGæ—¶åºç‰¹å¾æå–
- **masking.py**: EEGä¿¡å·çš„æ©ç ç­–ç•¥ï¼Œå¢å¼ºæ¨¡å‹é²æ£’æ€§

#### 2. `unet.py` - æ‰©æ•£å…ˆéªŒæ¨¡å‹

- **diffusion_prior**: ä»¥EEGä¸ºæ¡ä»¶å‘é‡ç”ŸæˆSDXLæ¨¡å‹é¢„è®­ç»ƒç©ºé—´ä¸­çš„CLIPå‘é‡çš„UNet Prior

#### 3. æ ¸å¿ƒè„šæœ¬

- **clip_feature_extractor.py**: å¤„ç†åŸå§‹æ•°æ®ï¼Œæå–CLIPç‰¹å¾ä¾›è®­ç»ƒä½¿ç”¨
- **dataset.py**: ç»Ÿä¸€çš„EEG-å›¾åƒ-æ–‡æœ¬æ•°æ®é›†åŠ è½½å™¨
- **train.py**: å¤šæ¨¡æ€æ‰©æ•£æ¨¡å‹è®­ç»ƒä¸»ç¨‹åº
- **generate.py**: æ”¯æŒåˆ†ç¦»ç”Ÿæˆã€è”åˆç”Ÿæˆå’Œæ¸è¿›ç”Ÿæˆçš„å›¾åƒç”Ÿæˆè„šæœ¬

## ğŸ”§ æŠ€æœ¯ç‰¹ç‚¹

### å¤šæ¨¡æ€èåˆç­–ç•¥

1. **åˆ†å±‚æ³¨å…¥**: ä¸åŒæ¨¡æ€ç‰¹å¾åœ¨UNetçš„ä¸åŒå±‚çº§æ³¨å…¥ï¼Œå®ç°ç²¾ç»†åŒ–æ§åˆ¶
2. **æ¸è¿›èåˆ**: æ”¯æŒä»ç®€å•åˆ°å¤æ‚çš„æ¨¡æ€ç»„åˆï¼Œå¢å¼ºå¯è§£é‡Šæ€§
3. **æƒé‡è‡ªé€‚åº”**: æ ¹æ®ä¸åŒæ¨¡æ€çš„é‡è¦æ€§åŠ¨æ€è°ƒæ•´èåˆæƒé‡

### ç”Ÿæˆæ¨¡å¼

- **åˆ†ç¦»ç”Ÿæˆ**: è¯„ä¼°æ¯ä¸ªæ¨¡æ€çš„ç‹¬ç«‹è´¡çŒ®
- **è”åˆç”Ÿæˆ**: å¤šæ¨¡æ€ç‰¹å¾èåˆç”Ÿæˆæœ€ä¼˜ç»“æœ
- **æ¸è¿›ç”Ÿæˆ**: å±•ç¤ºæ¨¡æ€ç´¯ç§¯çš„æ•ˆæœå˜åŒ–

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡    | å€¼    | è¯´æ˜                                      |
| :------ | :---- | :---------------------------------------- |
| FID â†“   | 88.03 | Frechet Inception Distance                |
| IS â†‘    | 31.41 | Inception Score                           |
| LPIPS â†“ | 0.684 | Learned Perceptual Image Patch Similarity |
| SSIM â†‘  | 0.217 | Structure Similarity Index Measure        |

## ğŸ™ è‡´è°¢

- æ„Ÿè°¢ [Things-EEG2](https://osf.io/2rzjq/) æ•°æ®é›†æä¾›è€…
- æ„Ÿè°¢ [Stability AI](https://stability.ai/) å¼€æºçš„ Stable Diffusion XL
- æ„Ÿè°¢æ‰€æœ‰ä¸ºæœ¬é¡¹ç›®æä¾›çµæ„Ÿå’Œä»£ç åŸºç¡€çš„å¼€å‘è€…

------

